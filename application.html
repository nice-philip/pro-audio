<!DOCTYPE html>
<html lang="ja-JP">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アルバム申請 - Surroundio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/application.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <style>
        .form-section {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .audio-specs-table {
            width: 100%;
            margin: 20px 0;
        }
        .audio-specs-table th, .audio-specs-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .audio-specs-table th {
            background-color: #f8f9fa;
        }
        .youtube-terms {
            height: 200px;
            overflow-y: scroll;
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .required-label::after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        .image-upload-guide {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .classic-fields {
            display: none;
        }
        #genre {
            max-height: 38px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/index" class="btn btn-outline-primary">
                <i class="fa fa-home"></i> <span>ホームへ戻る</span>
            </a>
            <h1 class="mb-0">アルバム申請</h1>
            <div style="width: 100px;"></div>
        </div>
        <form id="albumForm" class="needs-validation" novalidate>
            <!-- 基本情報 -->
            <div class="form-section">
                <h3 class="mb-4">基本情報</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nameEn" class="form-label required-label">名前（英語）</label>
                        <input type="text" class="form-control" id="nameEn" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nameKana" class="form-label required-label">名前（カナ）</label>
                        <input type="text" class="form-control" id="nameKana" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="email" class="form-label required-label">メールアドレス</label>
                        <input type="email" class="form-control" id="email" required>
                        <div class="invalid-feedback">
                            有効なメールアドレスを入力してください（@を含む必要があります）
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="password" class="form-label required-label">パスワード</label>
                        <input type="password" class="form-control" id="password" required>
                        <div class="invalid-feedback">
                            パスワードを入力してください
                        </div>
                        <small class="text-muted">予約確認時に必要となります</small>
                    </div>
                </div>
            </div>

            <!-- 楽曲情報 -->
            <div class="form-section">
                <h3 class="mb-4">楽曲情報</h3>
                <div id="songs-container">
                    <div class="song-entry" data-song-index="0">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="albumTitle" class="form-label required-label">アルバムタイトル</label>
                                <input type="text" class="form-control" id="albumTitle" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="songTitle_0" class="form-label required-label">曲名</label>
                                <input type="text" class="form-control" id="songTitle_0" name="songTitle[]" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="songTitleEn_0" class="form-label required-label">曲名（英語）</label>
                                <input type="text" class="form-control" id="songTitleEn_0" name="songTitleEn[]" required>
                            </div>
                        </div>

                        <!-- 日付と時間 -->
                        <div class="row date-time-fields" id="dateTimeFields_0">
                            <div class="col-md-6 mb-3">
                                <label for="date_0" class="form-label required-label">日付</label>
                                <input type="text" class="form-control datepicker" id="date_0" name="date[]" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="duration_0" class="form-label required-label">再生時間</label>
                                <input type="text" class="form-control time-input" id="duration_0" name="duration[]" placeholder="HH:mm:ss" required>
                                <small class="text-muted time-display">時間を入力してください (24時間制)</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="audioUpload_0" class="form-label required-label">音源ファイル（WAV形式）</label>
                            <input type="file" class="form-control" id="audioUpload_0" name="audio[]" accept=".wav" required>
                        </div>

                        <!-- クラシック楽曲情報 -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input classical-check" type="checkbox" id="isClassical_0" name="isClassical[]" data-index="0">
                                <label class="form-check-label" for="isClassical_0">クラシック楽曲</label>
                            </div>
                        </div>

                        <div id="classicalFields_0" class="classical-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="composer_0" class="form-label">作曲家</label>
                                    <input type="text" class="form-control" id="composer_0" name="composer[]">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="opusNumber_0" class="form-label">作品番号</label>
                                    <input type="text" class="form-control" id="opusNumber_0" name="opusNumber[]">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="movement_0" class="form-label">楽章</label>
                                    <input type="text" class="form-control" id="movement_0" name="movement[]">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tempo_0" class="form-label">速度記号</label>
                                    <input type="text" class="form-control" id="tempo_0" name="tempo[]">
                                </div>
                            </div>
                        </div>
                        <hr class="mt-4 mb-4">
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-secondary" onclick="addSongEntry()" id="addSongButton">曲を追加</button>
                    <button type="button" class="btn btn-danger ms-2" onclick="removeSongEntry()" id="removeSongButton" style="display: none;">削除</button>
                </div>

                <table class="audio-specs-table mt-5">
                    <thead>
                        <tr>
                            <th>種類</th>
                            <th>ファイル形式</th>
                            <th>標本サイズ</th>
                            <th>サンプリング周波数</th>
                            <th>チャンネル</th>
                            <th>曲の長さ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>通常</td>
                            <td>WAV形式</td>
                            <td>16ビット</td>
                            <td>44.1キロヘルツ</td>
                            <td>ステレオ</td>
                            <td>10分以内</td>
                        </tr>
                        <tr>
                            <td>高解像度</td>
                            <td>WAV形式</td>
                            <td>24ビット</td>
                            <td>44.1kHz, 48kHz, 88.2kHz, 96kHz, 176.4kHz, 192kHz</td>
                            <td>ステレオ</td>
                            <td>10分以内</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- アーティスト情報 -->
            <div class="form-section">
                <h3 class="mb-4">アーティスト情報</h3>
                <div class="mb-3">
                    <label for="artistInfo" class="form-label required-label">アーティスト情報</label>
                    <textarea class="form-control" id="artistInfo" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isReleased">
                        <label class="form-check-label" for="isReleased">アルバムリリース済み</label>
                    </div>
                </div>
            </div>

            <!-- ファイルアップロード -->
            <div class="form-section">
                <h3 class="mb-4">ファイルアップロード</h3>
                <div class="mb-3">
                    <label for="imageUpload" class="form-label required-label">ジャケット画像（JPG形式、3000x3000）</label>
                    <input type="file" class="form-control" id="imageUpload" accept=".jpg,.jpeg" required>
                    <div class="image-upload-guide">
                        推奨サイズ: 3000x3000ピクセル
                    </div>
                </div>
            </div>

            <!-- ジャンル選択 -->
            <div class="form-section">
                <h3 class="mb-4">ジャンル</h3>
                <div class="mb-3">
                    <label for="genre" class="form-label required-label">ジャンルを選択</label>
                    <select class="form-select" id="genre" required>
                        <option value="">ジャンルを選択してください</option>
                        <option value="pop">ポップス</option>
                        <option value="rock">ロック</option>
                        <option value="jazz">ジャズ</option>
                        <option value="classical">クラシック</option>
                        <option value="electronic">エレクトロニック</option>
                        <option value="hiphop">ヒップホップ</option>
                        <option value="rb">R&B</option>
                        <option value="folk">フォーク</option>
                        <option value="world">ワールド</option>
                        <option value="ambient">アンビエント</option>
                        <option value="metal">メタル</option>
                        <option value="blues">ブルース</option>
                        <option value="country">カントリー</option>
                        <option value="experimental">エクスペリメンタル</option>
                        <option value="fusion">フュージョン</option>
                    </select>
                </div>
            </div>

            <!-- YouTube収益化サービス -->
            <div class="form-section">
                <h3 class="mb-4">YouTube収益化サービス</h3>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="youtubeMonetize" id="youtubeYes" required>
                        <label class="form-check-label" for="youtubeYes">利用する</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="youtubeMonetize" id="youtubeNo">
                        <label class="form-check-label" for="youtubeNo">利用しない</label>
                    </div>
                </div>

                <div class="youtube-terms">
                    <h4>YouTube収益化サービスの内容と注意事項</h4>
                    <p>YouTube収益化サービス*1は第三者がYouTubeにアップロードした動画に会員様の楽曲が使用された場合、音源に関する権利として収益を得ることができるサービスです。ぜひご活用ください。詳しい内容は<a href="#" target="_blank">こちら</a>をクリックしてください。</p>
                    
                    <p>ただし、本サービスで配信された楽曲を使用してYouTubeに動画をアップロードする場合、YouTubeにて「著作権侵害の申し立て」と判断される可能性があります。その際、著作権者として「massenext株式会社（ナラスの代理人）」※2が表示されます。</p>
                    
                    <p>※ この場合の「著作権」は「原盤権（音源に関する権利）」を指します。「作詞または作曲に関する著作権」を指すものではありません。</p>
                    
                    <p>著作権侵害の申し立てを取り下げたい場合は、以下の情報と共にお問い合わせフォームよりご連絡ください：</p>
                    <ul>
                        <li>申し立てられた動画のURL</li>
                        <li>対象楽曲タイトル</li>
                        <li>対象リリースのJANコード</li>
                    </ul>

                    <p>「YouTube収益化サービス」の登録対象外となる楽曲は以下の通りです：</p>
                    <ul>
                        <li>パブリックドメインに帰属する知的創作物を含む楽曲（例：クラシック音楽の音源）</li>
                        <li>第三者が権利を付与またはライセンスを付与した音源を含む楽曲（サンプリングされた音源、許諾された音源など）</li>
                        <li>フリー音源（音楽制作ソフトウェアのループ音源素材、効果音、音源素材など）を含む楽曲</li>
                        <li>原曲と異ならないカバー曲（例：有名アーティストの模倣曲）</li>
                        <li>カラオケ、アカペラ、器楽曲、断片、リマスタリング、原曲のライブバージョンなど</li>
                        <li>オリジナルエディション以外のアルバム（コンピレーションエディション、リマスターエディション、ベストエディション、DJミックスエディションなど）</li>
                        <li>30秒未満の楽曲</li>
                        <li>音楽以外のポッドキャスト、スピーチ、インタビュー、朗読会およびその他のコンテンツ</li>
                        <li>区別が困難な楽曲（例：自然音、環境音、ヨガ、睡眠）</li>
                        <li>当社以外のサービスを通じてYouTubeの「YouTube収益化サービス」に登録された楽曲</li>
                    </ul>

                    <p>※1 「YouTube収益化サービス」に登録すると、YouTube Musicへの配信も自動的に行われます。</p>
                    <p>※2 ナラスはYouTube（Google）と音楽契約を結んでいるmassenext株式会社とビジネス提携を結んでいます。「YouTube収益化サービス」は音楽エージェントサイトZULAを運営する株式会社massenextを通じて運営・管理されます。YouTubeでの「著作権」という表記には「マスター権利」も含まれており、ここでの「著作権」は「マスター権利」を表します。</p>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="youtubeAgree" required>
                    <label class="form-check-label" for="youtubeAgree">利用規約に同意します</label>
                </div>
            </div>

            <!-- PayPal -->
            <div class="form-section">
                <h3 class="mb-4">PayPal</h3>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </div>

            <!-- 送信ボタン -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg">申請する</button>
            </div>
        </form>
    </div>

    <div class="container">
        <div class="footer-flex-container">
            <p class="text-uppercase small templatemo-copyright">Surroundio copyright © 2022 Nationalux Canada, All rights reserved.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script>
        // Initialize datepicker and time input for the first song
        $(document).ready(function() {
            // Add beforeunload event handler
            window.addEventListener('beforeunload', function(e) {
                // Cancel the event
                e.preventDefault();
                // Chrome requires returnValue to be set
                e.returnValue = 'ページを離れると、入力した内容が失われます。';
            });

            // Remove beforeunload event handler when form is submitted successfully
            document.getElementById('albumForm').addEventListener('submit', function() {
                window.removeEventListener('beforeunload', function(e) {
                    e.preventDefault();
                    e.returnValue = 'ページを離れると、入力した内容が失われます。';
                });
            });

            $("#date_0").datepicker({
                dateFormat: 'yy年mm月dd日',
                monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                dayNames: ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'],
                dayNamesMin: ['日', '月', '火', '水', '木', '金', '土'],
                showMonthAfterYear: true,
                yearSuffix: '年'
            });

            // Time input formatting
            $(document).on('input', '.time-input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length > 6) {
                    value = value.substr(0, 6);
                }
                if (value.length >= 4) {
                    value = value.substr(0, 2) + ':' + value.substr(2, 2) + ':' + value.substr(4);
                } else if (value.length >= 2) {
                    value = value.substr(0, 2) + ':' + value.substr(2);
                }
                $(this).val(value);
            });
        });

        let songCount = 1;
        const MAX_SONGS = 3;

        function addSongEntry() {
            if (songCount >= MAX_SONGS) {
                alert('最大3曲までアップロード可能です');
                return;
            }

            const container = document.getElementById('songs-container');
            const template = document.querySelector('.song-entry').cloneNode(true);
            
            // Update IDs and names
            template.setAttribute('data-song-index', songCount);
            
            // Remove date field but keep duration for additional songs
            const dateTimeFields = template.querySelector('.date-time-fields');
            if (dateTimeFields && songCount > 0) {
                const dateField = dateTimeFields.querySelector('[name="date[]"]').parentElement;
                dateField.remove();
                
                // Update duration field container classes
                const durationField = dateTimeFields.querySelector('[name="duration[]"]').parentElement;
                dateTimeFields.classList.remove('row');
                durationField.classList.remove('col-md-6');
                durationField.classList.add('col-md-12');
            }
            
            // Update IDs and clear values
            template.querySelectorAll('[id]').forEach(element => {
                const oldId = element.id;
                const newId = oldId.replace(/_\d+$/, `_${songCount}`);
                element.id = newId;
                
                // Clear input values
                if (element.tagName === 'INPUT') {
                    if (element.type === 'text' || element.type === 'file') {
                        element.value = '';
                    } else if (element.type === 'checkbox') {
                        element.checked = false;
                    }
                }
                
                // Update data-index for classical-check
                if (element.classList.contains('classical-check')) {
                    element.setAttribute('data-index', songCount);
                }
            });

            // Update label for attributes
            template.querySelectorAll('label[for]').forEach(label => {
                const oldFor = label.getAttribute('for');
                const newFor = oldFor.replace(/_\d+$/, `_${songCount}`);
                label.setAttribute('for', newFor);
            });

            // Update classical fields container ID
            const classicalFields = template.querySelector('.classical-fields');
            classicalFields.id = `classicalFields_${songCount}`;
            classicalFields.style.display = 'none';

            container.appendChild(template);
            songCount++;

            // Update add button state
            if (songCount >= MAX_SONGS) {
                document.getElementById('addSongButton').disabled = true;
            }

            // Show remove button if more than one song
            document.getElementById('removeSongButton').style.display = songCount > 1 ? 'inline-block' : 'none';
        }

        function removeSongEntry() {
            if (songCount <= 1) {
                return;
            }

            const container = document.getElementById('songs-container');
            container.removeChild(container.lastChild);
            songCount--;

            // Update button states
            document.getElementById('addSongButton').disabled = false;
            document.getElementById('removeSongButton').style.display = songCount > 1 ? 'inline-block' : 'none';
        }

        // Update classical fields toggle function
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('classical-check')) {
                const index = e.target.getAttribute('data-index');
                const fields = document.getElementById(`classicalFields_${index}`);
                fields.style.display = e.target.checked ? 'block' : 'none';
            }
        });

        // Remove old functions that are no longer needed
        function addMoreSongs() {}
        function toggleClassicalFields() {}
        function toggleAddClassicalFields() {}
        function submitAdditionalSong() {}

        // Update form submission to handle multiple songs
        document.getElementById('albumForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!this.checkValidity()) {
                event.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const formData = new FormData();
            const submitButton = document.querySelector('button[type="submit"]');
            let uploadComplete = false;

            try {
                submitButton.disabled = true;
                submitButton.innerHTML = '提出中...';

                // Basic information
                formData.append('nameEn', document.getElementById('nameEn').value);
                formData.append('nameKana', document.getElementById('nameKana').value);
                formData.append('email', document.getElementById('email').value);
                formData.append('albumTitle', document.getElementById('albumTitle').value);

                // Collect all songs data
                document.querySelectorAll('.song-entry').forEach((songEntry, index) => {
                    const songData = {
                        songTitle: document.getElementById(`songTitle_${index}`).value,
                        songTitleEn: document.getElementById(`songTitleEn_${index}`).value,
                        duration: document.getElementById(`duration_${index}`).value || "00:00:00"
                    };

                    // Only add date for the first song
                    if (index === 0) {
                        songData.date = document.getElementById(`date_${index}`).value;
                    }

                    if (document.getElementById(`isClassical_${index}`).checked) {
                        songData.composer = document.getElementById(`composer_${index}`).value;
                        songData.opusNumber = document.getElementById(`opusNumber_${index}`).value;
                        songData.movement = document.getElementById(`movement_${index}`).value;
                        songData.tempo = document.getElementById(`tempo_${index}`).value;
                    }

                    const audioFile = document.getElementById(`audioUpload_${index}`).files[0];
                    if (audioFile) {
                        formData.append(`audio_${index}`, audioFile);
                    }

                    // Add song data as JSON string for each song
                    formData.append(`songs[${index}]`, JSON.stringify(songData));
                });

                formData.append('songs', JSON.stringify(songs));
                formData.append('artistInfo', document.getElementById('artistInfo').value);
                formData.append('genre', document.getElementById('genre').value);
                formData.append('isReleased', document.getElementById('isReleased').checked);
                
                // YouTube related fields
                const youtubeMonetize = document.getElementById('youtubeYes').checked ? 'yes' : 'no';
                const youtubeAgree = document.getElementById('youtubeAgree').checked;
                
                formData.append('youtubeMonetize', youtubeMonetize);
                formData.append('youtubeAgree', youtubeAgree);

                // Cover image
                const imageFile = document.getElementById('imageUpload').files[0];
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                const response = await fetch("https://pro-audio-jp-1.onrender.com/api/reservations", {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Origin': 'https://surroundio.today'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || 'アップロードに失敗しました';
                    } catch (e) {
                        errorMessage = errorText || 'サーバーエラーが発生しました';
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Upload successful:', result);
                uploadComplete = true;
                alert("✅ アップロードが完了しました");
                
                await new Promise(resolve => setTimeout(resolve, 100));
                this.reset();
                document.querySelectorAll('.classical-fields').forEach(field => {
                    field.style.display = 'none';
                });
                
                // Reset song count and remove additional song entries
                songCount = 1;
                const container = document.getElementById('songs-container');
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
                document.getElementById('addSongButton').disabled = false;

            } catch (error) {
                console.error("❌ アップロード失敗:", error);
                let errorMessage = error.message;
                if (error.response) {
                    try {
                        const errorData = await error.response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                }
                alert("❌ " + errorMessage);
            } finally {
                if (!uploadComplete) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '提出する';
                }
            }
        });

        // 파일 업로드 유효성 검사
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const img = new Image();
                img.onload = function() {
                    if (img.width !== 3000 || img.height !== 3000) {
                        alert('画像サイズは3000x3000ピクセルである必要があります');
                        event.target.value = '';
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });

        // PayPal Button Initialization
        paypal.Buttons({
            style: {
                layout: 'vertical',
                color:  'blue',
                shape:  'rect',
                label:  'paypal'
            },
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '20000',
                            currency_code: 'JPY'
                        },
                        description: 'Surroundio オーディオ処理サービス'
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    alert('お支払いが完了しました！ご利用ありがとうございます。');
                });
            },
            onError: function(err) {
                console.error('PayPal Error:', err);
            }
        }).render('#paypal-button-container');
    </script>
</body>
</html> 