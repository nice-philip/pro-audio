<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アルバム申請 - Surroundio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/application.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <style>
        .form-section {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .audio-specs-table {
            width: 100%;
            margin: 20px 0;
        }
        .audio-specs-table th, .audio-specs-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .audio-specs-table th {
            background-color: #f8f9fa;
        }
        .youtube-terms {
            height: 200px;
            overflow-y: scroll;
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .required-label::after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        .image-upload-guide {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .classic-fields {
            display: none;
        }
        #genre {
            max-height: 38px;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/index" class="btn btn-outline-primary">
                <i class="fa fa-home"></i> ホームへ戻る
            </a>
            <h1 class="mb-0">アルバム申請</h1>
            <div style="width: 100px;"></div>
        </div>
        <form id="albumForm" class="needs-validation" novalidate>
            <!-- 基本情報 -->
            <div class="form-section">
                <h3 class="mb-4">基本情報</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nameEn" class="form-label required-label">名前（英語）</label>
                        <input type="text" class="form-control" id="nameEn" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nameKana" class="form-label required-label">名前（カナ）</label>
                        <input type="text" class="form-control" id="nameKana" required>
                    </div>
                </div>
            </div>

            <!-- 楽曲情報 -->
            <div class="form-section">
                <h3 class="mb-4">楽曲情報</h3>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="albumTitle" class="form-label required-label">アルバムタイトル</label>
                        <input type="text" class="form-control" id="albumTitle" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="songTitle" class="form-label required-label">曲名</label>
                        <input type="text" class="form-control" id="songTitle" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="songTitleEn" class="form-label required-label">曲名（英語）</label>
                        <input type="text" class="form-control" id="songTitleEn" required>
                    </div>
                </div>

                <!-- 日付と時間 -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="date" class="form-label required-label">日付</label>
                        <input type="text" class="form-control" id="date" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="time" class="form-label required-label">時間</label>
                        <input type="text" class="form-control time-input" id="time" placeholder="HH:mm:ss" required>
                        <small class="text-muted time-display">時間を入力してください (24時間制)</small>
                    </div>
                </div>

                <!-- クラシック楽曲情報 -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isClassical" onchange="toggleClassicalFields()">
                        <label class="form-check-label" for="isClassical">クラシック楽曲</label>
                    </div>
                </div>

                <div id="classicalFields" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="composer" class="form-label">作曲家</label>
                            <input type="text" class="form-control" id="composer">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="opusNumber" class="form-label">作品番号</label>
                            <input type="text" class="form-control" id="opusNumber">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="movement" class="form-label">楽章</label>
                            <input type="text" class="form-control" id="movement">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tempo" class="form-label">速度記号</label>
                            <input type="text" class="form-control" id="tempo">
                        </div>
                    </div>
                </div>
            </div>

            <!-- アーティスト情報 -->
            <div class="form-section">
                <h3 class="mb-4">アーティスト情報</h3>
                <div class="mb-3">
                    <label for="artistInfo" class="form-label required-label">アーティスト情報</label>
                    <textarea class="form-control" id="artistInfo" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isReleased">
                        <label class="form-check-label" for="isReleased">アルバムリリース済み</label>
                    </div>
                </div>
            </div>

            <!-- ファイルアップロード -->
            <div class="form-section">
                <h3 class="mb-4">ファイルアップロード</h3>
                <div class="mb-3">
                    <label for="imageUpload" class="form-label required-label">ジャケット画像（JPG形式、3000x3000）</label>
                    <input type="file" class="form-control" id="imageUpload" accept=".jpg,.jpeg" required>
                    <div class="image-upload-guide">
                        推奨サイズ: 3000x3000ピクセル
                    </div>
                </div>

                <div class="mb-3">
                    <label for="audioUpload" class="form-label required-label">音源ファイル（WAV形式）</label>
                    <input type="file" class="form-control" id="audioUpload" accept=".wav" required>
                </div>

                <table class="audio-specs-table">
                    <thead>
                        <tr>
                            <th>種類</th>
                            <th>ファイル形式</th>
                            <th>標本サイズ</th>
                            <th>サンプリング周波数</th>
                            <th>チャンネル</th>
                            <th>曲の長さ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>通常</td>
                            <td>WAV形式</td>
                            <td>16ビット</td>
                            <td>44.1キロヘルツ</td>
                            <td>ステレオ</td>
                            <td>10分以内</td>
                        </tr>
                        <tr>
                            <td>高解像度</td>
                            <td>WAV形式</td>
                            <td>24ビット</td>
                            <td>44.1kHz, 48kHz, 88.2kHz, 96kHz, 176.4kHz, 192kHz</td>
                            <td>ステレオ</td>
                            <td>10分以内</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ジャンル選択 -->
            <div class="form-section">
                <h3 class="mb-4">ジャンル</h3>
                <div class="mb-3">
                    <label for="genre" class="form-label required-label">ジャンルを選択</label>
                    <select class="form-select" id="genre" required>
                        <option value="">ジャンルを選択してください</option>
                        <option value="pop">ポップス</option>
                        <option value="rock">ロック</option>
                        <option value="jazz">ジャズ</option>
                        <option value="classical">クラシック</option>
                        <option value="electronic">エレクトロニック</option>
                        <option value="hiphop">ヒップホップ</option>
                        <option value="rb">R&B</option>
                        <option value="folk">フォーク</option>
                        <option value="world">ワールド</option>
                        <option value="ambient">アンビエント</option>
                        <option value="metal">メタル</option>
                        <option value="blues">ブルース</option>
                        <option value="country">カントリー</option>
                        <option value="experimental">エクスペリメンタル</option>
                        <option value="fusion">フュージョン</option>
                    </select>
                </div>
            </div>

            <!-- YouTube収益化サービス -->
            <div class="form-section">
                <h3 class="mb-4">YouTube収益化サービス</h3>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="youtubeMonetize" id="youtubeYes" required>
                        <label class="form-check-label" for="youtubeYes">利用する</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="youtubeMonetize" id="youtubeNo">
                        <label class="form-check-label" for="youtubeNo">利用しない</label>
                    </div>
                </div>

                <div class="youtube-terms">
                    <h4>YouTube収益化サービスの内容と注意事項</h4>
                    <p>YouTube収益化サービス*1は第三者がYouTubeにアップロードした動画に会員様の楽曲が使用された場合、音源に関する権利として収益を得ることができるサービスです。ぜひご活用ください。詳しい内容は<a href="#" target="_blank">こちら</a>をクリックしてください。</p>
                    
                    <p>ただし、本サービスで配信された楽曲を使用してYouTubeに動画をアップロードする場合、YouTubeにて「著作権侵害の申し立て」と判断される可能性があります。その際、著作権者として「massenext株式会社（ナラスの代理人）」※2が表示されます。</p>
                    
                    <p>※ この場合の「著作権」は「原盤権（音源に関する権利）」を指します。「作詞または作曲に関する著作権」を指すものではありません。</p>
                    
                    <p>著作権侵害の申し立てを取り下げたい場合は、以下の情報と共にお問い合わせフォームよりご連絡ください：</p>
                    <ul>
                        <li>申し立てられた動画のURL</li>
                        <li>対象楽曲タイトル</li>
                        <li>対象リリースのJANコード</li>
                    </ul>

                    <p>「YouTube収益化サービス」の登録対象外となる楽曲は以下の通りです：</p>
                    <ul>
                        <li>パブリックドメインに帰属する知的創作物を含む楽曲（例：クラシック音楽の音源）</li>
                        <li>第三者が権利を付与またはライセンスを付与した音源を含む楽曲（サンプリングされた音源、許諾された音源など）</li>
                        <li>フリー音源（音楽制作ソフトウェアのループ音源素材、効果音、音源素材など）を含む楽曲</li>
                        <li>原曲と異ならないカバー曲（例：有名アーティストの模倣曲）</li>
                        <li>カラオケ、アカペラ、器楽曲、断片、リマスタリング、原曲のライブバージョンなど</li>
                        <li>オリジナルエディション以外のアルバム（コンピレーションエディション、リマスターエディション、ベストエディション、DJミックスエディションなど）</li>
                        <li>30秒未満の楽曲</li>
                        <li>音楽以外のポッドキャスト、スピーチ、インタビュー、朗読会およびその他のコンテンツ</li>
                        <li>区別が困難な楽曲（例：自然音、環境音、ヨガ、睡眠）</li>
                        <li>当社以外のサービスを通じてYouTubeの「YouTube収益化サービス」に登録された楽曲</li>
                    </ul>

                    <p>※1 「YouTube収益化サービス」に登録すると、YouTube Musicへの配信も自動的に行われます。</p>
                    <p>※2 ナラスはYouTube（Google）と音楽契約を結んでいるmassenext株式会社とビジネス提携を結んでいます。「YouTube収益化サービス」は音楽エージェントサイトZULAを運営する株式会社massenextを通じて運営・管理されます。YouTubeでの「著作権」という表記には「マスター権利」も含まれており、ここでの「著作権」は「マスター権利」を表します。</p>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="youtubeAgree" required>
                    <label class="form-check-label" for="youtubeAgree">利用規約に同意します</label>
                </div>
            </div>

            <!-- 送信ボタン -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg">申請する</button>
                <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="addMoreSongs()">曲を追加</button>
            </div>
        </form>

        <!-- 追加曲フォーム用モーダル -->
        <div class="modal fade" id="addSongModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">曲を追加</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="additionalSongForm">
                            <!-- 曲情報 -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="addSongTitle" class="form-label required-label">曲名</label>
                                    <input type="text" class="form-control" id="addSongTitle" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="addSongTitleEn" class="form-label required-label">曲名（英語）</label>
                                    <input type="text" class="form-control" id="addSongTitleEn" required>
                                </div>
                            </div>

                            <!-- 日付と時間 -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="addDate" class="form-label required-label">日付</label>
                                    <input type="text" class="form-control" id="addDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="addTime" class="form-label required-label">時間</label>
                                    <input type="text" class="form-control time-input" id="addTime" placeholder="HH:mm:ss" required>
                                    <small class="text-muted time-display">時間を入力してください (24時間制)</small>
                                </div>
                            </div>

                            <!-- 音源ファイル -->
                            <div class="mb-3">
                                <label for="addAudioUpload" class="form-label required-label">音源ファイル（WAV形式）</label>
                                <input type="file" class="form-control" id="addAudioUpload" accept=".wav" required>
                            </div>

                            <!-- クラシック楽曲情報 -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="addIsClassical" onchange="toggleAddClassicalFields()">
                                    <label class="form-check-label" for="addIsClassical">クラシック楽曲</label>
                                </div>
                            </div>

                            <div id="addClassicalFields" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="addComposer" class="form-label">作曲家</label>
                                        <input type="text" class="form-control" id="addComposer">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="addOpusNumber" class="form-label">作品番号</label>
                                        <input type="text" class="form-control" id="addOpusNumber">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="addMovement" class="form-label">楽章</label>
                                        <input type="text" class="form-control" id="addMovement">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="addTempo" class="form-label">速度記号</label>
                                        <input type="text" class="form-control" id="addTempo">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-primary" onclick="submitAdditionalSong()">追加</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="footer-flex-container">
            <p class="text-uppercase small templatemo-copyright">Surroundio copyright © 2022 Nationalux Canada, All rights reserved.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script>
        // クラシック楽曲フィールドの表示/非表示
        function toggleClassicalFields() {
            const classicalFields = document.getElementById('classicalFields');
            const isClassical = document.getElementById('isClassical').checked;
            classicalFields.style.display = isClassical ? 'block' : 'none';
        }

        function toggleAddClassicalFields() {
            const addClassicalFields = document.getElementById('addClassicalFields');
            const isClassical = document.getElementById('addIsClassical').checked;
            addClassicalFields.style.display = isClassical ? 'block' : 'none';
        }

        // 日付ピッカーの初期化
        $(document).ready(function() {
            $("#date, #addDate").datepicker({
                dateFormat: 'yy年mm月dd日',
                monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                dayNames: ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'],
                dayNamesMin: ['日', '月', '火', '水', '木', '金', '土'],
                showMonthAfterYear: true,
                yearSuffix: '年'
            });
        });

        // 時間入力のフォーマット
        $('.time-input').on('input', function() {
            let value = $(this).val().replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substr(0, 6);
            }
            if (value.length >= 4) {
                value = value.substr(0, 2) + ':' + value.substr(2, 2) + ':' + value.substr(4);
            } else if (value.length >= 2) {
                value = value.substr(0, 2) + ':' + value.substr(2);
            }
            $(this).val(value);
        });

        // 追加曲モーダルを表示
        function addMoreSongs() {
            const modal = new bootstrap.Modal(document.getElementById('addSongModal'));
            modal.show();
        }

        // 追加曲の送信
        async function submitAdditionalSong() {
            const form = document.getElementById('additionalSongForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const formData = new FormData();
            const submitButton = document.querySelector('.modal-footer .btn-primary');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSongModal'));

            try {
                submitButton.disabled = true;
                submitButton.innerHTML = '送信中...';

                // メインフォームから基本情報を取得
                formData.append('nameEn', document.getElementById('nameEn').value);
                formData.append('nameKana', document.getElementById('nameKana').value);
                formData.append('albumTitle', document.getElementById('albumTitle').value);

                // 追加曲の情報
                formData.append('songTitle', document.getElementById('addSongTitle').value);
                formData.append('songTitleEn', document.getElementById('addSongTitleEn').value);
                formData.append('date', document.getElementById('addDate').value);
                formData.append('time', document.getElementById('addTime').value);

                // クラシック情報
                const isClassical = document.getElementById('addIsClassical').checked;
                formData.append('isClassical', isClassical);
                if (isClassical) {
                    formData.append('composer', document.getElementById('addComposer').value);
                    formData.append('opusNumber', document.getElementById('addOpusNumber').value);
                    formData.append('movement', document.getElementById('addMovement').value);
                    formData.append('tempo', document.getElementById('addTempo').value);
                }

                // オーディオファイル
                const audioFile = document.getElementById('addAudioUpload').files[0];
                if (audioFile) formData.append('audio', audioFile);

                console.log('Sending form data to server...');
                const response = await fetch("https://pro-audio-jp-1.onrender.com/api/reservations", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        throw new Error(result.message || 'アップロードに失敗しました');
                    } else {
                        throw new Error('サーバーエラーが発生しました');
                    }
                }

                const result = await response.json();
                console.log('Upload successful:', result);
                alert("✅ アップロードが完了しました！");
                
                // フォームリセット前に少し待機
                await new Promise(resolve => setTimeout(resolve, 100));
                form.reset();
                document.getElementById('addClassicalFields').style.display = 'none';
                modal.hide();

            } catch (error) {
                console.error("❌ アップロード失敗:", error);
                alert("❌ " + (error.message || '曲の追加に失敗しました。もう一度お試しください。'));
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '追加';
            }
        }

        // フォームバリデーション
        document.getElementById('albumForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!this.checkValidity()) {
                event.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const formData = new FormData();
            const submitButton = document.querySelector('button[type="submit"]');
            let uploadComplete = false;

            try {
                submitButton.disabled = true;
                submitButton.innerHTML = '送信中...';

                // 날짜를 ISO 형식으로 변환
                const japaneseDate = document.getElementById('date').value;
                const dateMatch = japaneseDate.match(/(\d{4})年(\d{2})月(\d{2})日/);
                const isoDate = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : japaneseDate;

                // 폼 데이터 구성
                formData.append('nameEn', document.getElementById('nameEn').value);
                formData.append('nameKana', document.getElementById('nameKana').value);
                formData.append('albumTitle', document.getElementById('albumTitle').value);
                formData.append('songTitle', document.getElementById('songTitle').value);
                formData.append('songTitleEn', document.getElementById('songTitleEn').value);
                formData.append('date', isoDate);
                formData.append('time', document.getElementById('time').value);
                formData.append('composer', document.getElementById('composer').value);
                formData.append('opusNumber', document.getElementById('opusNumber').value);
                formData.append('movement', document.getElementById('movement').value);
                formData.append('tempo', document.getElementById('tempo').value);
                formData.append('artistInfo', document.getElementById('artistInfo').value);
                formData.append('genre', document.getElementById('genre').value);

                // 체크박스/라디오 버튼 값을 올바른 형식으로 변환
                formData.append('isClassical', document.getElementById('isClassical').checked);
                formData.append('isReleased', document.getElementById('isReleased').checked);
                
                // YouTube 관련 필드 처리
                const youtubeMonetize = document.getElementById('youtubeYes').checked ? 'yes' : 'no';
                const youtubeAgree = document.getElementById('youtubeAgree').checked;
                
                formData.append('youtubeMonetize', youtubeMonetize);
                formData.append('youtubeAgree', youtubeAgree);

                console.log('Form data values:', {
                    youtubeMonetize,
                    youtubeAgree
                });

                // 파일 업로드
                const imageFile = document.getElementById('imageUpload').files[0];
                const audioFile = document.getElementById('audioUpload').files[0];
                
                if (!imageFile) {
                    throw new Error('커버 이미지를 선택해주세요');
                }
                if (!audioFile) {
                    throw new Error('오디오 파일을 선택해주세요');
                }

                formData.append('image', imageFile);
                formData.append('audio', audioFile);

                console.log('Sending form data to server...');
                const response = await fetch("https://pro-audio-jp-1.onrender.com/api/reservations", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        throw new Error(result.message || '업로드에 실패했습니다');
                    } else {
                        throw new Error('서버 오류가 발생했습니다');
                    }
                }

                const result = await response.json();
                console.log('Upload successful:', result);
                uploadComplete = true;
                alert("✅ 업로드가 완료되었습니다!");
                
                // 폼 리셋 전에 잠시 대기
                await new Promise(resolve => setTimeout(resolve, 100));
                this.reset();
                document.getElementById('classicalFields').style.display = 'none';

            } catch (error) {
                console.error("❌ 업로드 실패:", error);
                let errorMessage = error.message;
                if (error.response) {
                    try {
                        const errorData = await error.response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                }
                alert("❌ " + errorMessage);
            } finally {
                if (!uploadComplete) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '신청하기';
                }
            }
        });

        // 파일 업로드 유효성 검사
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const img = new Image();
                img.onload = function() {
                    if (img.width !== 3000 || img.height !== 3000) {
                        alert('이미지 크기는 3000x3000 픽셀이어야 합니다.');
                        event.target.value = '';
                    }
                };
                img.src = URL.createObjectURL(file);
            }
        });
    </script>
</body>
</html> 